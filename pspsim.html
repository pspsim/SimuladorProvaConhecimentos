<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Simulador PSP</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
  header { background-color: #003366; color: white; position: relative; height: 140px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-weight: bold; overflow: hidden; }
  header .title { font-size: 2.8rem; letter-spacing: 1px; text-transform: uppercase; z-index: 2; }
  header .subtitle { font-size: 1.05rem; font-style: italic; margin-top: 8px; text-align: center; max-width: 90%; z-index: 2; }
  header .stripes { position: absolute; bottom: -60px; right: -20px; width: 240px; height: 300px; transform-origin: bottom right; transform: rotate(17deg); pointer-events: none; background: linear-gradient(to right, #003366 0%, #003366 30%, white 30%, white 38%, #003366 38%, #003366 48%, white 48%, white 55%, #003366 55%, #003366 65%, white 65%, white 72%, #003366 72%, #003366 100%); }
  h2 { margin-top: 30px; color: #003366; border-bottom: 2px solid #003366; padding-bottom: 5px; }
  .question { margin-bottom: 20px; padding: 10px; background: white; border-radius: 5px; }
  .options label { display: block; margin-bottom: 5px; }
  #timer { font-size: 20px; font-weight: bold; text-align: center; margin: 20px 0; }
  #submit { display: block; margin: 20px auto; padding: 10px 20px; font-size: 16px; }
  #result { margin-top: 20px; font-size: 18px; font-weight: bold; text-align: center; }
</style>
</head>
<body>

<header>
  <div class="title">SIMULADOR PSP</div>
  <div class="subtitle">Simulação da Prova de Conhecimentos da Polícia de Segurança Pública</div>
  <div class="stripes"></div>
</header>

<div id="timer">02:00:00</div>
<form id="quizForm"></form>
<button id="submit">Submeter Teste</button>
<div id="result"></div>

<script>
const quizForm = document.getElementById("quizForm");
const timerDiv = document.getElementById("timer");
const submitBtn = document.getElementById("submit");
const resultDiv = document.getElementById("result");

let testQuestions = []; // perguntas processadas com info do input e resposta

// ====== FUNÇÃO PARA EMBARALHAR ======
function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// ====== CARREGAR JSON ======
async function loadQuestions() {
  try {
    const res = await fetch("https://raw.githubusercontent.com/pspsim/SimuladorProvaConhecimentos/main/root/questions.json");

    // agrupar por tópico (usando string, ex: "I", "II")
  const topics = {};
  data.questions.forEach(q=>{
    if(!topics[q.topic]) topics[q.topic]=[];
    topics[q.topic].push(q);
  });


    // Criar formulário
    Object.keys(topics).forEach(topicKey => {
      const topicQuestions = shuffleArray(topics[topicKey]);

      // Título do tópico
      const h2 = document.createElement("h2");
      h2.textContent = `Tópico ${topicKey}`;
      quizForm.appendChild(h2);

      topicQuestions.forEach(q => {
        const div = document.createElement("div");
        div.className = "question";
        div.dataset.idx = q.idx;

        const p = document.createElement("p");
        p.textContent = q.question;
        div.appendChild(p);

        // Embaralhar opções (manter "Todas as anteriores" no fim)
        let opts = [...q.options];
        let todasOption;
        const todasIndex = opts.findIndex(o => o.startsWith("Todas"));
        if (todasIndex !== -1) {
          todasOption = opts.splice(todasIndex, 1)[0];
          opts = shuffleArray(opts);
          opts.push(todasOption);
        } else {
          opts = shuffleArray(opts);
        }

        opts.forEach((opt, i) => {
          const label = document.createElement("label");
          label.innerHTML = `O ${String.fromCharCode(65 + i)}) <input type="radio" name="q${q.idx}" value="${i}"> ${opt}`;
          div.appendChild(label);
        });

        quizForm.appendChild(div);

        // Guardar info para correção
        testQuestions.push({
          inputName: `q${q.idx}`,
          correct: q.correct, // índice 0-3
          optionsRendered: opts,
          questionDiv: div
        });
      });
    });

  } catch (err) {
    console.error("Erro a carregar JSON:", err);
  }
}

// ====== TIMER ======
let time = 2 * 60 * 60; // 2 horas
let timerInterval;
function startTimer() {
  timerInterval = setInterval(() => {
    const h = String(Math.floor(time / 3600)).padStart(2, '0');
    const m = String(Math.floor((time % 3600) / 60)).padStart(2, '0');
    const s = String(time % 60).padStart(2, '0');
    timerDiv.textContent = `${h}:${m}:${s}`;
    if (time <= 0) {
      clearInterval(timerInterval);
      submitTest();
    }
    time--;
  }, 1000);
}

// ====== SUBMETER E CORRIGIR ======
function submitTest() {
  clearInterval(timerInterval);
  let scoreCount = 0;

  testQuestions.forEach(q => {
    // Limpar feedback antigo
    q.questionDiv.querySelectorAll('.feedback').forEach(f => f.remove());
    q.questionDiv.style.border = "2px solid #ccc";

    const feedback = document.createElement("div");
    feedback.className = "feedback";
    feedback.style.marginTop = "8px";
    feedback.style.fontWeight = "bold";

    const selected = document.querySelector(`input[name="${q.inputName}"]:checked`);
    if (selected) {
      const userIndex = parseInt(selected.value);
      if (userIndex === q.correct) {
        scoreCount++;
        q.questionDiv.style.border = "2px solid green";
        feedback.style.color = "green";
        feedback.textContent = "✔ Resposta correta";
      } else {
        q.questionDiv.style.border = "2px solid red";
        feedback.style.color = "red";
        feedback.innerHTML = `
          ✘ Resposta errada<br>
          A tua resposta: O ${String.fromCharCode(65 + userIndex)}) ${q.optionsRendered[userIndex]}<br>
          Resposta correta: O ${String.fromCharCode(65 + q.correct)}) ${q.optionsRendered[q.correct]}
        `;
      }
    } else {
      q.questionDiv.style.border = "2px solid orange";
      feedback.style.color = "orange";
      feedback.textContent = "⚠ Pergunta não respondida";
    }

    q.questionDiv.appendChild(feedback);
  });

  const finalScore = (scoreCount / testQuestions.length) * 20;
  resultDiv.textContent = `Acertaste ${scoreCount}/${testQuestions.length} perguntas. Nota final: ${finalScore.toFixed(2)}/20`;
}

// ====== EVENTO SUBMIT ======
submitBtn.addEventListener("click", e => {
  e.preventDefault();
  submitTest();
});

// ====== INICIAR ======
loadQuestions().then(startTimer);
</script>
</body>
</html>